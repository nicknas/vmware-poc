#cloud-config

{% set disk_letter = (97 + next_unit_number) | int | chr %}
{% set device = "/dev/sd" ~ disk_letter %}
{% set pv = device %}
{% set vg = "vg_data" %}
{% set lv = "lv_data" %}
{% set lvpath = "/dev/" ~ vg ~ "/" ~ lv %}
{% set mountpoint = "/data" %}

write_files:
  - path: /usr/local/bin/configure_lvm.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      DEVICE="{{ device }}"
      PV="{{ pv }}"
      VG="{{ vg }}"
      LV="{{ lv }}"
      LV_PATH="{{ lvpath }}"
      MOUNTPOINT="{{ mountpoint }}"

      echo "[INFO] Using device: $DEVICE"

      # Wait for disk to be available
      for i in {1..10}; do
          if lsblk "$DEVICE"; then
              break
          fi
          sleep 1
      done

      # Create partition table if needed
      if ! lsblk ${DEVICE}1 &>/dev/null; then
          echo "[INFO] Creating GPT partition table"
          parted -s $DEVICE mklabel gpt
          parted -s $DEVICE mkpart primary 0% 100%
          sleep 2
      fi

      PART="${DEVICE}1"

      # Create PV
      if ! pvs $PART &>/dev/null; then
          pvcreate $PART
      fi

      # Create or extend VG
      if ! vgs $VG &>/dev/null; then
          vgcreate $VG $PART
      else
          vgextend $VG $PART || true
      fi

      # Create LV if not exists
      if ! lvs $LV_PATH &>/dev/null; then
          lvcreate -l 100%FREE -n $LV $VG
      fi

      # Create filesystem XFS
      if ! blkid $LV_PATH | grep -q xfs; then
          mkfs.xfs $LV_PATH
      fi

      mkdir -p $MOUNTPOINT

      # Add to fstab if not exists
      if ! grep -qs "$LV_PATH" /etc/fstab; then
          echo "$LV_PATH $MOUNTPOINT xfs defaults 0 0" >> /etc/fstab
      fi

      mount -a


runcmd:
  - [ bash, /usr/local/bin/configure_lvm.sh ]

