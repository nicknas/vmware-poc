---
# tasks/add_nic.yml

- name: Add Network Interface via vCenter (Delegated)
  # Adds the NIC without modifying existing hardware configuration
  community.vmware.vmware_guest_network:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_password }}"
    name: "{{ vm_name }}"
    datacenter: "{{ datacenter }}"
    network_name: "{{ network_name }}"
    label: "label"
    device_type: "{{ nic_device_type }}"
    state: present
    connected: true
  delegate_to: localhost
  register: nic_result

- name: Gather VM Facts from vCenter
  # We need to refresh vCenter info to get the generated MAC address
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_user}}"
    password: "{{ vcenter_password }}"
    name: "{{ vm_name }}"
    datacenter: "{{ datacenter }}"
  delegate_to: localhost
  register: vm_info

- name: Extract New MAC Address (From network_info)
  ansible.builtin.set_fact:
    expected_mac_address: >-
      {{
        nic_result.network_info
        | selectattr('network_name', 'equalto', network_name)
        | map(attribute='mac_address')
        | list
        | first
      }}
  delegate_to: localhost

- name: Debug - Expected MAC
  ansible.builtin.debug:
    msg: "vCenter assigned MAC {{ expected_mac_address }} to network {{ network_name }}"

# -------------------------------------------------------
# TASK 3: Verification - The 'Zero-Touch' Check
# Instead of SSHing into the VM, we ask vCenter:
# "Has the Guest OS (via VMware Tools) reported this MAC address yet?"
#
# 'instance.guest_net' contains network data reported by the OS driver.
# If the MAC is here, the OS has recognized the card and the driver is loaded.
# -------------------------------------------------------
- name: Wait for Guest OS to detect the interface (VMware Tools)
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_password }}"
    name: "{{ vm_name }}"
  register: vm_info
  # Loop Condition:
  # Keep retrying until 'expected_mac_address' appears inside the 
  # 'guest_net' list (the OS view of the network).
  until: >
    vm_info.instance.guest_net is defined and
    expected_mac_address in (vm_info.instance.guest_net | map(attribute='mac_address') | list)
  retries: 20   # Try 20 times
  delay: 6  # Wait 6 seconds between tries (Total wait: ~2 mins)
  delegate_to: localhost     

# -------------------------------------------------------
# TASK 4: Final Confirmation (Optional IP Check)
# -------------------------------------------------------
- name: Success Message
  ansible.builtin.debug:
    msg: "SUCCESS: The OS is UP and has recognized the interface {{ expected_mac_address }}."