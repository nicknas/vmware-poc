---
# tasks/verify_nic.yml

- name: Wait for connection and Guest OS stabilization
  # Hot-plugging hardware might take a few seconds for the kernel to register.
  ansible.builtin.wait_for_connection:
    timeout: "{{ connection_timeout | default(60) }}"

- name: Refresh Guest OS Network Facts
  # We must force a fact gathering now because the initial playbook facts 
  # (if gathered) would not contain the new NIC.
  # We use 'gather_subset: network' for performance.
  ansible.builtin.setup:
    gather_subset:
      - network

- name: DEBUG - Mostrar interfaces detectadas
  ansible.builtin.debug:
    msg: 
      - "Interfaces listadas: {{ ansible_interfaces }}"
      # Esto mostrará la estructura completa de la primera interfaz para ver dónde está la MAC
      - "Ejemplo de datos de la primera interfaz: {{ ansible_facts[ansible_interfaces[0]] | default('No data') }}"

- name: Collect all MAC addresses (Linux/Unix logic)
  ansible.builtin.set_fact:
    detected_macs: >-
      {{
        ansible_interfaces
        | map('extract', ansible_facts)
        | selectattr('macaddress', 'defined')
        | map(attribute='macaddress')
        | map('lower')
        | list
      }}
    when: ansible_os_family != 'Windows'

- name: Assert that the new MAC address is present in the OS
  ansible.builtin.assert:
    that:
      - "expected_mac_address | lower in detected_macs"
    fail_msg: >-
      FAILURE: La MAC {{ expected_mac_address }} no aparece en el SO.
      MACs encontradas: {{ detected_macs }}
    success_msg: "SUCCESS: La interfaz con MAC {{ expected_mac_address }} ha sido detectada correctamente."