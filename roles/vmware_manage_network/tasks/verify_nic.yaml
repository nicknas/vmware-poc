---
# tasks/verify_nic.yml

- name: Wait for connection and Guest OS stabilization
  # Hot-plugging hardware might take a few seconds for the kernel to register.
  ansible.builtin.wait_for_connection:
    timeout: "{{ connection_timeout | default(60) }}"

- name: Refresh Guest OS Network Facts
  # We must force a fact gathering now because the initial playbook facts 
  # (if gathered) would not contain the new NIC.
  # We use 'gather_subset: network' for performance.
  ansible.builtin.setup:
    gather_subset:
      - network

- name: Assert that the new MAC address is present in the OS
  ansible.builtin.assert:
    that:
      # Compare the vCenter MAC (converted to lower case) against all MACs 
      # found in the OS (also converted to lower case).
      - "expected_mac_address | lower in ansible_facts.values() | selectattr('macaddress', 'defined') | map(attribute='macaddress') | map('lower') | list"
    fail_msg: >-
      FAILURE: The MAC {{ expected_mac_address }} was NOT found in the Guest OS.
      Visible MACs: {{ ansible_facts.values() | selectattr('macaddress', 'defined') | map(attribute='macaddress') | list }}
    success_msg: "SUCCESS: The interface with MAC {{ expected_mac_address }} has been successfully detected by the OS."