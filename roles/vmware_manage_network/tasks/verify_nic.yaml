---
# tasks/verify_nic.yml

- name: Wait for connection and Guest OS stabilization
  # Hot-plugging hardware might take a few seconds for the kernel to register.
  ansible.builtin.wait_for_connection:
    timeout: "{{ connection_timeout | default(60) }}"

- name: Refresh Guest OS Network Facts
  # We must force a fact gathering now because the initial playbook facts 
  # (if gathered) would not contain the new NIC.
  # We use 'gather_subset: network' for performance.
  ansible.builtin.setup:
    gather_subset:
      - network

- name: Debug - Display detected interfaces
  ansible.builtin.debug:
    # FIX: We access 'interfaces' via the 'ansible_facts' dictionary.
    # This prevents the 'undefined variable' error when facts are not injected as top-level vars.
    msg: 
      - "Interfaces found: {{ ansible_facts.interfaces | default('None detected') }}"
      - "Expected MAC: {{ expected_mac_address }}"

- name: Assert that the new MAC address is present in the OS
  ansible.builtin.assert:
    that:
      # Verification Logic:
      # 1. 'ansible_facts.interfaces': Get the list of interface names (e.g., ['eth0', 'ens192']).
      # 2. 'map('extract', ansible_facts)': Look up the details for each name inside ansible_facts.
      # 3. 'selectattr': Filter only interfaces that actually have a MAC address.
      # 4. 'map': Extract the MAC string and convert to lowercase for comparison.
      - "expected_mac_address | lower in ansible_facts.interfaces | map('extract', ansible_facts) | selectattr('macaddress', 'defined') | map(attribute='macaddress') | map('lower') | list"
    fail_msg: >-
      FAILURE: The MAC {{ expected_mac_address }} was NOT found in the Guest OS.
      Visible MACs: {{ ansible_facts.interfaces | map('extract', ansible_facts) | selectattr('macaddress', 'defined') | map(attribute='macaddress') | list }}
    success_msg: "SUCCESS: The interface with MAC {{ expected_mac_address }} has been correctly detected by the OS."